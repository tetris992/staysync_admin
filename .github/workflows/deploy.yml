# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Deploy to GitHub Pages

# ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ
  pull_request:
    branches:
      - main # main ë¸Œëœì¹˜ë¡œ Pull Requestê°€ ìƒì„±ë  ë•Œ

# (ê°œì„ ) ë™ì‹œì— ì—¬ëŸ¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ì—¬ ì•ˆì •ì„± í™•ë³´
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# (ê°œì„ ) ì›Œí¬í”Œë¡œìš° ì¡ì— í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ë¶€ì—¬í•˜ì—¬ ë³´ì•ˆ ê°•í™”
permissions:
  contents: write # gh-pages ë¸Œëœì¹˜ì— ì½”ë“œë¥¼ í‘¸ì‹œí•˜ê¸° ìœ„í•´ 'write' ê¶Œí•œ í•„ìš”

jobs:
  build-and-deploy:
    # ì‹¤í–‰ í™˜ê²½ ì§€ì •
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code ğŸ›ï¸
        uses: actions/checkout@v4

      # 2. Node.js í™˜ê²½ ì„¤ì • (NPM ìºì‹œ í¬í•¨)
      - name: Set up Node.js âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜ (npm ci ì‚¬ìš©ìœ¼ë¡œ ì¼ê´€ì„± ìˆëŠ” ì„¤ì¹˜ ë³´ì¥)
      - name: Install dependencies ğŸ“¦
        run: npm ci

      # 4. ì½”ë“œ ë¦°íŠ¸ ê²€ì‚¬ (ì½”ë“œ í’ˆì§ˆ ìœ ì§€)
      - name: Lint code âœ¨
        run: npm run lint -- --max-warnings=0

      # 5. í”„ë¡œë•ì…˜ ë¹Œë“œ ì‹¤í–‰
      - name: Build application ğŸ—ï¸
        env:
          REACT_APP_API_BASE_URL: ${{ secrets.REACT_APP_API_BASE_URL }}
          PUBLIC_URL: /staysync_admin # GitHub Pagesì˜ ì„œë¸Œë””ë ‰í† ë¦¬ ê²½ë¡œ
        run: npm run build

      # 6. GitHub Pagesì— ë°°í¬
      # main ë¸Œëœì¹˜ì— 'push' ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œë§Œ ì´ ë‹¨ê³„ë¥¼ ì‹¤í–‰
      - name: Deploy to GitHub Pages ğŸš€
        if: github.ref == 'refs/heads/main'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build # ë¹Œë“œ ê²°ê³¼ë¬¼ì´ ìˆëŠ” í´ë”
          branch: gh-pages # ë°°í¬í•  ë¸Œëœì¹˜
          clean: true # ë°°í¬ ë¸Œëœì¹˜ë¥¼ ê¹¨ë—í•˜ê²Œ ì •ë¦¬ í›„ ë°°í¬

      # 7. ë°°í¬ í™•ì¸ (ê°„ë‹¨í•œ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸)
      - name: Verify deployment âœ…
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. https://ztoone.kr/staysync_admin ì—ì„œ í™•ì¸í•˜ì„¸ìš”."
          # curlì„ í†µí•´ ë°°í¬ëœ í˜ì´ì§€ì˜ HTTP ìƒíƒœ ì½”ë“œë¥¼ í™•ì¸í•©ë‹ˆë‹¤. (ë°°í¬ í›„ ì ìš©ê¹Œì§€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ)
          sleep 10 # GitHub Pages ë°°í¬ ë°˜ì˜ì„ ìœ„í•œ ëŒ€ê¸° ì‹œê°„
          curl -s -o /dev/null -w "%{http_code}" https://ztoone.kr/staysync_admin | grep -q "200" || echo "ë°°í¬ í™•ì¸ì— ì‹¤íŒ¨í–ˆê±°ë‚˜, ì•„ì§ í˜ì´ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."